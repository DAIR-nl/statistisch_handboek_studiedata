---
title: "Gepaarde t-test"
output:
  html_document:
    theme: lumen
    toc: yes
    toc_float: 
      collapsed: FALSE 
    number_sections: true
    keep_md: true
  keywords: [statistisch handboek, studiedata]
  
---

<style>
`r htmltools::includeHTML(paste0(here::here(),"/03. Includes/css/Stylesheet SHHO.css"))`
</style>

```{r header, include = FALSE, echo = TRUE, results='asis'} 
paste0(here::here(),"/03. Includes/code/Header.R")
```

<!-- ## BLOK: Functiedefinities.R -->
```{r functiedefinities,include=FALSE, echo=TRUE}
library(stringr)
Round_and_format <- function(x, digits = 2) {
  x <- as.character(round(x, digits))
  x <- str_replace(x, "[.]", ",")
  return(x)
}
```
<!-- ## /BLOK: Functiedefinities.R -->

``` {r versiegeschiedenis, include = FALSE, eval = FALSE}
## versie 0.1     3-9-19
## versie 0.2     4-9-19
## versie 0.3     5-9-19   
```
```{r opmerking, include=FALSE, eval=FALSE}
# ipv Cohen's d kan ook eta squared gebruikt worden om effectmaat te berekenen. Wordt vaak wel gedaan bij de ANOVA. 
# doorlinken naar de Wilcoxon Signed Rank Test
# linken naar blz transformeren data 
# link naar 
```

<!-- ## BLOK: Data-aanmaken.R -->
```{r aanmaken data, include=FALSE, echo=TRUE}
RNGkind(sample.kind = "Rounding")
set.seed(2)
library(dplyr)

## Maak ruwe data aan
mu <- 7.2
sigma <- 1.5
Tentamencijfer_na_tutorgesprek <- rnorm(250, mu, sigma)

Tentamencijfer_na_tutorgesprek <- 
  Tentamencijfer_na_tutorgesprek[Tentamencijfer_na_tutorgesprek <= 10
                                 & Tentamencijfer_na_tutorgesprek >= 1]

mu <- 6.8
sigma <- 1.8
Tentamencijfer_voor_tutorgesprek <- rnorm(260, mu, sigma)

Tentamencijfer_voor_tutorgesprek <- 
  Tentamencijfer_voor_tutorgesprek[Tentamencijfer_voor_tutorgesprek <= 10
                                   & Tentamencijfer_voor_tutorgesprek >= 1]

## Stel volgorde en lengte van steekproef vast
volgorde <- sample(1:length(Tentamencijfer_na_tutorgesprek), length(Tentamencijfer_na_tutorgesprek))
volgorde_n30 <- sample(1:30, 30)
Verschil_grootte <- length(Tentamencijfer_voor_tutorgesprek) - length(Tentamencijfer_na_tutorgesprek)

## Rond evaluatiecijfers af
Tentamencijfer_na_tutorgesprek <- sapply(Tentamencijfer_na_tutorgesprek, round, 3)
Tentamencijfer_voor_tutorgesprek <- sapply(Tentamencijfer_voor_tutorgesprek, round, 3)

## Definiëer lengte in steekproef en hussel paren
Tentamencijfer_na_tutorgesprek <- sort(Tentamencijfer_na_tutorgesprek)
Tentamencijfer_na_tutorgesprek <- Tentamencijfer_na_tutorgesprek[volgorde]
Tentamencijfer_voor_tutorgesprek <- sort(Tentamencijfer_voor_tutorgesprek)
Tentamencijfer_voor_tutorgesprek <- Tentamencijfer_voor_tutorgesprek[sample(-283:-1, Verschil_grootte)]
Tentamencijfer_voor_tutorgesprek <- Tentamencijfer_voor_tutorgesprek[volgorde]

Voor_of_na_tutorgesprek <- c(
  replicate(length(Tentamencijfer_voor_tutorgesprek), "voor"), 
  replicate(length(Tentamencijfer_na_tutorgesprek), "na"))
Studentnr <- c(replicate(2, sample(300000:400000, (length(Voor_of_na_tutorgesprek)/2))))
Cijfer <- c(Tentamencijfer_voor_tutorgesprek, Tentamencijfer_na_tutorgesprek)

Tentamencijfers <- data.frame(Studentnr, Cijfer, Voor_of_na_tutorgesprek)

## Stel de volgorde van de factor vast
Tentamencijfers <- 
  mutate(Tentamencijfers, 
         Voor_of_na_tutorgesprek =
                  factor(Voor_of_na_tutorgesprek, levels = c("voor", "na")))

mu <- 7.2
sigma <- 1.2
Tentamencijfer_voor_tutorgesprek_n30 <- rnorm(30, mu, sigma)

Tentamencijfer_voor_tutorgesprek_n30 <- Tentamencijfer_voor_tutorgesprek_n30[Tentamencijfer_voor_tutorgesprek_n30 <= 10 
                                                                 & Tentamencijfer_voor_tutorgesprek_n30 >= 1]
Tentamencijfer_voor_tutorgesprek_n30 <- sapply(Tentamencijfer_voor_tutorgesprek_n30, round, 3)
Tentamencijfer_voor_tutorgesprek_n30 <- sort(Tentamencijfer_voor_tutorgesprek_n30)
Tentamencijfer_voor_tutorgesprek_n30 <- Tentamencijfer_voor_tutorgesprek_n30[volgorde_n30]

mu <- 7.0
sigma <- 0.8
Tentamencijfer_na_tutorgesprek_n30 <- rnorm(30, mu, sigma)

Tentamencijfer_na_tutorgesprek_n30 <-
  Tentamencijfer_na_tutorgesprek_n30[Tentamencijfer_na_tutorgesprek_n30 <= 10 &
                                      Tentamencijfer_na_tutorgesprek_n30 >= 1]
Tentamencijfer_na_tutorgesprek_n30 <- sapply(Tentamencijfer_na_tutorgesprek_n30, round, 3)
Tentamencijfer_na_tutorgesprek_n30 <- sort(Tentamencijfer_na_tutorgesprek_n30)
Tentamencijfer_na_tutorgesprek_n30 <- Tentamencijfer_na_tutorgesprek_n30[volgorde_n30]
```
<!-- ## /BLOK: Data-aanmaken.R -->

# Toepassing
Gebruik de *t-toets* om te toetsen of de gemiddeldes van twee groepen aan elkaar gelijk zijn. Gebruik de *gepaarde t-toets* bij een herhaalde meting van dezelfde groep.[^1] 

# Onderwijscasus
Ter voorbereiding op een visitatie vraagt de opleidingsdirecteur van de lerarenopleiding zich af of het gemiddelde tentamencijfer veranderd na een tutorgesprek. Ze bekijkt het gemiddelde tentamencijfer van de onderwijsperiode voor het tutorgesprek (T~0~) en het gemiddelde cijfer van de onderwijsperiode na het tutorgesprek (T~1~). 

H~0~: Het gemiddelde tentamencijfer per onderwijsperiode verandert niet na het tutorgesprek, µ~T0~ = µ~T1~  

H~A~: Het gemiddelde tentamencijfer per onderwijsperiode verandert na het tutorgesprek, µ~T0~ ≠ µ~T1~ 


# Assumpties
Voor een betrouwbaar resultaat moet de data aan een aantal voorwaarden voldoen voordat de toets uitgevoerd kan worden.

## Normaliteit
De *t-toets* gaat ervan uit dat de data normaal verdeeld is. Ga er bij een *n* > 100 vanuit dat de *t-toets* robuust genoeg is om uit te voeren zonder dat de data een normale verdeling volgt.[^2]   

Controleer de assumptie van normaliteit met de volgende stappen:  
1. Controleer de data visueel met een histogram, een Q-Q plot of een boxplot.
2. Toets of de data normaal verdeeld is met de *Kolmogorov-Smirnov test* of bij een kleinere steekproef (n < 50[^3]) met de *Shapiro-Wilk test*.[^4]  
3. Als blijkt dat de data niet normaal verdeeld is, transformeer de data eventueel en bepaal daarna of deze wel normaal verdeeld is. 

Als er geen sprake is van normaliteit en *n* is niet groter dan 100, gebruik de *Wilcoxon Signed Rank Test*.[^5]

# Effectmaat
Bereken de effectmaat om te bepalen of de gevonden p-waarde betekenisvol is. Een veel gebruikte effectmaat is Cohen's *d*. Cohen's *d* geeft de sterkte van het effect van een onafhankelijke variabele op een afhankelijke variabele weer.  
Een indicatie om *d* te interpreteren is: rond 0,3 is een klein effect, rond 0,5 is een gemiddeld effect en rond 0,8 is een groot effect.[^6]  

# Uitvoering in R
Er is een dataset ingeladen met `Tentamencijfer_voor_tutorgesprek` (T~0~) en met `Tentamencijfer_na_tutorgesprek` (T~1~). 

## De data bekijken
Gebruik `head()` en `tail()` om de structuur van de data te bekijken.
<!-- ## BLOK: Data-bekijken.R -->
```{r data bekijken, collapse = TRUE}
## Eerste 5 observaties
head(Tentamencijfers)

## Laatste 5 observaties
tail(Tentamencijfers)
```
<!-- ## /BLOK: Data-bekijken.R -->

Selecteer beide groepen en sla deze op in een vector om deze makkelijker aan te kunnen roepen.
<!-- ## BLOK: Data-selecteren.R -->
```{r data selecteren}
Tentamencijfer_voor_tutorgesprek <-
  Tentamencijfers[Tentamencijfers$Voor_of_na_tutorgesprek=="voor", 2]
Tentamencijfer_na_tutorgesprek <- 
  Tentamencijfers[Tentamencijfers$Voor_of_na_tutorgesprek=="na", 2]
```
<!-- ## /BLOK: Data-selecteren.R -->

<div class="col2">
<!-- ## BLOK: Data-beschrijven-1.R -->
```{r data beschrijven t1, collapse = TRUE}
## Aantallen, gemiddelde en standaarddeviatie voor tutorgesprek
length(Tentamencijfer_voor_tutorgesprek)
mean(
  Tentamencijfer_voor_tutorgesprek)
sd(Tentamencijfer_voor_tutorgesprek)
```
<!-- ## /BLOK: Data-beschrijven-1.R -->
```{r Var beschrijven t0, include=FALSE, echo=TRUE}
vMeant0 <- Round_and_format(mean(Tentamencijfer_voor_tutorgesprek))
vSDt0 <-Round_and_format(sd(Tentamencijfer_voor_tutorgesprek))
vNt0 <- Round_and_format(length(Tentamencijfer_voor_tutorgesprek))
```
  
<!-- ## BLOK: Data-beschrijven-2.R -->
```{r data bekijken t2, collapse=TRUE}
## Aantallen, gemiddelde en standaarddeviatie na tutorgesprek
length(Tentamencijfer_na_tutorgesprek)
mean(
  Tentamencijfer_na_tutorgesprek)
sd(Tentamencijfer_na_tutorgesprek)
```
<!-- ## /BLOK: Data-beschrijven-2.R -->
```{r Var beschrijven t1, include=FALSE, echo=TRUE}
vMeant1 <- Round_and_format(mean(Tentamencijfer_na_tutorgesprek))
vSDt1 <- Round_and_format(sd(Tentamencijfer_na_tutorgesprek))
vNt1 <- Round_and_format(length(Tentamencijfer_na_tutorgesprek))
```
</div>

* Gemiddeld tentamencijfer na tutorgesprek (standaardafwijking): `r vMeant1` (`r vSDt1`). *n* = `r vNt0`.
* Gemiddeld tentamencijfer voor tutorgesprek (standaardafwijking): `r vMeant0` (`r vSDt0`). *n* = `r vNt1`.

## Visuele inspectie van normaliteit
Geef normaliteit visueel weer met een histogram, boxplot of Q-Q plot. 

### Histogram
<!-- ## BLOK: library-ggplot2.R -->
```{r library ggplot2}
library(ggplot2)
```
<!-- ## /BLOK: library-ggplot2.R -->

<!-- ## BLOK: Histogram.R -->
```{r histogram atc}
ggplot(Tentamencijfers,
  aes(x = Cijfer)) +
  geom_histogram(aes(y = ..density..),
                 binwidth = 1,
                 color = "grey30",
                 fill = "#0089CF") +
  facet_wrap(~ Voor_of_na_tutorgesprek) +
  geom_density(alpha = .2, adjust = 1) +
  ylab("Frequentiedichtheid") +
  scale_x_continuous(
    labels = as.character(seq(1, 10)),
    breaks = seq(1, 10)) +
  coord_fixed(ylim = c(0, 0.4),
              xlim = c(1, 10),
              ratio = 22) +
  labs(title = "Lerarenopleiding tentamencijfers")
```
<!-- ## /BLOK: Histogram.R -->


Beide histogrammen laten een belcurve zien vergelijkbaar aan een normale verdeling. Veel waardes liggen rondom de gemiddeldes. Opvallend is dat het histogram van voor het tutorgesprek veel waardes in de linkerstaart van de verdeling heeft liggen.  

### Q-Q plot
Gebruik `qqnorm()` en `qqline()`. Gebruik `pch = 1`om kleine cirkels als datapunten te gebruiken.

Als over het algemeen de meeste datapunten op de lijn liggen, kan aangenomen worden dat de data normaal verdeeld is.
<div class ="col2">
<!-- ## BLOK: QQplot-t1.R -->
```{r qqplot voor tutor}
qqnorm(Tentamencijfer_voor_tutorgesprek, 
       pch = 1,
       main = "Normaal Q-Q plot van tentamencijfers voor tutorgesprek",
       ylab = "Kwantielen in data",
       xlab = "Theoretische kwantielen")
qqline(Tentamencijfer_voor_tutorgesprek)
```
<!-- ## /BLOK: QQplot-t1.R -->

<!-- ## BLOK: QQplot-t2.R -->
```{r qqplot na tutor}
qqnorm(Tentamencijfer_na_tutorgesprek, 
       pch = 1,
       main = "Normaal Q-Q plot van tentamencijfers na tutorgesprek",
       ylab = "Kwantielen in data",
       xlab = "Theoretische kwantielen")
qqline(Tentamencijfer_na_tutorgesprek)
```
<!-- ## /BLOK: QQplot-t2.R -->
</div>

Als over het algemeen de meeste datapunten op de lijn liggen, kan aangenomen worden dat de data normaal verdeeld is. In deze casus liggen de meeste punten op de lijn behalve bij de uiteinden. 

### Boxplot
Controleer de data visueel met een boxplot.  
De box geeft de middelste 50% van de tentamencijfers weer. De zwarte lijn binnen de box is de mediaan. In de staarten zitten de eerste 25% en de laatste 25%. Cirkels zijn uitbijters.  

<!-- ## BLOK: Boxplot.R -->
``` {r Boxplot}
boxplot(Cijfer ~ Voor_of_na_tutorgesprek, Tentamencijfers,
        main = "Boxplot van tentamencijfers lerarenopleiding")
```
<!-- ## /BLOK: Boxplot.R -->
De boxplotten geven de spreiding weer van het gemiddelde tentamencijfer per periode voor de lerarenopleiding. De boxplot en de staarten van T~0~ zijn niet helemaal symmetrisch. Dit kan een teken zijn dat de data niet normaal verdeeld is. Het gaat om een kleine afwijking, daarom is de data vermoedelijk normaal verdeeld. Er zijn een aantal uitbijters. Er kan gekeken worden of de uitbijters bepalend zijn voor normaliteit of niet.  
De boxplot van T~1~ ziet er symmetrisch uit. Er zijn geen uitbijters.    

***

Om te controleren of de data normaal verdeeld is, kan de normaliteit getoetst worden. Hierbij een toelichting bij twee veel gebruikte toetsen: de *Kolmogorov-Smirnov test* en de *Shapiro-Wilk test*.


### Kolmogorov-Smirnov (met Lilliefors correctie)
De *Kolmogorov-Smirnov test* toetst het verschil in vorm tussen de twee verdelingen. In dit geval toetst deze test het verschil tussen een normale verdeling en de verdeling van de steekproef. De Lilliefors correctie is een correctie op de *Kolmogorov-Smirnov test*, die wordt gebruikt als het gemiddelde van de steekproef niet 0 is en de standaardafwijking niet 1 is. Als de p-waarde groter is dan 0,05 is de verdeling van de data niet significant verschillend van een normale verdeling. 
<!-- ## BLOK: Library-nortest -->
```{r library nortest, warning=FALSE}
library(nortest)
```
<!-- ## /BLOK: Library-nortest -->
<div class ="col2">
<!-- ## BLOK: Lilliefors-test -->
``` {r Lilliefors Test, warning=FALSE}
lillie.test(
  Tentamencijfer_voor_tutorgesprek)
lillie.test(
  Tentamencijfer_na_tutorgesprek)
```
<!-- ## /BLOK: Lilliefors-test -->
</div>

Bij deze casus is van beide groepen de p-waarde > 0,05; er is geen significant verschil gevonden tussen de verdeling van de steekproef en de normale verdeling. Er wordt aan de assumptie van normaliteit voldaan, dus de *gepaarde t-toets* kan uitgevoerd worden. 

### Shapiro-Wilk Test
De *Shapiro-Wilk test* is een soortgelijke test als de *Kolmogorov-Smirnov test* en wordt vooral gebruikt bij kleine steekproeven. Als de p-waarde groter is dan 0,05 is de verdeling van de data niet significant verschillend van de normale verdeling.
<div class ="col2">
<!-- ## BLOK: Shapiro-Wilk-test -->
``` {r Shapiro-Wilk Test, warning=FALSE}
shapiro.test(
  Tentamencijfer_voor_tutorgesprek_n30)
shapiro.test(
  Tentamencijfer_na_tutorgesprek_n30)
```
<!-- ## /BLOK: Shapiro-Wilk-test -->
</div>

In dit voorbeeld, met een kleine *n*, hebben beide groepen een p-waarde > 0,05. De verdeling van beide groepen is niet significant verschillend van de normale verdeling. Er wordt aan de assumptie van normaliteit voldaan. De *gepaarde t-toets* kan uitgevoerd worden.  

***

## Gepaarde t-toets
Gebruik `t.test()` met `paired = TRUE`.
<!-- ## BLOK: T-test -->
```{r T-test}
t.test(Cijfer ~ Voor_of_na_tutorgesprek, Tentamencijfers, paired = TRUE)
```
<!-- ## BLOK: T-test -->
```{r T-test als item, echo = FALSE}
t <- t.test(Cijfer ~ Voor_of_na_tutorgesprek, Tentamencijfers, paired = TRUE)
vT_waarde <- Round_and_format(t$statistic)
vN <- t$parameter+1
vDF <- t$parameter
vConf.int1 <- Round_and_format(t$conf.int[1])
vConf.int2 <- Round_and_format(t$conf.int[2])
```

* Vrijheidsgraden, *df* = *n* -1 = `r vN`-1 = `r vDF`  
* p-waarde < 0,05, dus de H~0~ wordt verworpen en de H~A~ wordt aangenomen
* *t* (`r vN`) = `r vT_waarde`, *p* < 0,01
* 95%-betrouwbaarheidsinterval: bij het herhalen van het onderzoek zal in 95% van de gevallen de µ in het interval vallen. In deze casus is het interval tussen `r vConf.int1` en `r vConf.int2`.

### Effectmaat: Cohen's d
Gebruik `cohen.d()` met `paired = TRUE` om de effectgrootte te meten.
```{r Cohens d}
library(effsize)
cohen.d(Cijfer ~ Voor_of_na_tutorgesprek, Tentamencijfers, paired = TRUE)
```
```{r var Cohens d, echo = FALSE}
d <- cohen.d(Cijfer ~ Voor_of_na_tutorgesprek, Tentamencijfers, paired = TRUE)
vD_waarde <- Round_and_format(d$estimate)
```
*d* = `r vD_waarde`. De sterkte van het effect van de tutor op het cijfer is minimaal. 

# Rapportage
Een *gepaarde t-toets* is uitgevoerd om te toetsen of het gemiddelde tentamencijfer van de studenten gelijk is gebleven na een gesprek met hun tutor. Het verschil tussen het gemiddelde van T~0~ (*M~T0~* = `r vMeant0`, *SD~T0~* = `r vSDt0`) en het gemiddelde van T~1~ (*M~T1~* =`r vMeant1`, *SD~T1~* = `r vSDt1`) is significant, *t* (`r vDF`) = `r vT_waarde`, *p* < 0,01. Het 95% betrouwbaarheidsinterval voor het verschil tussen het gemiddelde van beide groepen is van `r vConf.int1` tot `r vConf.int2`. Het valt op dat het gemiddelde van T~1~ hoger is dan van T~0~. Het effect is minimaal, *d* = `r vD_waarde`. 

Aan de hand van de resultaten kan geconcludeerd worden dat de studenten, na een gesprek met de tutor, de opleiding beter beoordelen dan daarvoor. Het effect is minimaal.  

[^1]: Wikipedia (21 augustus 2019). *Student's t-test*. https://en.wikipedia.org/wiki/Student%27s_t-test
[^2]: Lumley, T., Diehr, P., Emerson, S., & Chen, L. (2002). Tthe importance of the normality assumption in large public health data sets. *Annu Rev Public Health, 23*, 151-69. doi: 10.1146/annurev.publheath.23.100901.140546 http://rctdesign.org/techreports/arphnonnormality.pdf 
[^3]: van Geloven, N. (25 september2013). *Wilcoxon signed rank toets*.  https://wikistatistiek.amc.nl/index.php/Wilcoxon_signed_rank_toets
[^4]: Laerd statistics (2018). *Testing for Normality using SPSS Statistics*. https://statistics.laerd.com/spss-tutorials/testing-for-normality-using-spss-statistics.php  
[^5]: Universiteit van Amsterdam (14 juli 2014). *Normaliteit*. https://wiki.uva.nl/methodologiewinkel/index.php/Normaliteit  
[^6]: Marshall, E., & Boggis, E. (2016). *The statistics tutor’s quick guide to commonly used statistical tests*. http://www.statstutor.ac.uk/resources/uploaded/tutorsquickguidetostatistics.pdf 
---
title: "Cochran's Q toets"
output:
  html_document:
    theme: lumen
    toc: yes
    toc_float: 
      collapsed: FALSE 
    number_sections: true
  keywords: [statistisch handboek, studiedata]
---

<!-- ## CLOSEDBLOK: Functies.R -->
```{r functies, include = TRUE, echo = FALSE, results='asis', warning=FALSE, message=FALSE}
library(here)
if (!exists("Substitute_var")) {
  ## Installeer packages en functies
  source(paste0(here::here(), "/99. Functies en Libraries/00. Voorbereidingen.R"), echo = FALSE)
}
```
<!-- ## /CLOSEDBLOK: Functies.R -->

<!-- ## CLOSEDBLOK: CSS -->
<style>
`r htmltools::includeHTML(paste0(here::here(),"/01. Includes/css/Stylesheet_SHHO.css"))`
</style>
<!-- ## /CLOSEDBLOK: CSS -->

<!-- ## CLOSEDBLOK: Header.R -->
```{r header, include = TRUE, echo = FALSE, results='asis', code =  readLines(paste0(here::here(),"/01. Includes/code/Header.R"))} 
```
<!-- ## /CLOSEDBLOK: Header.R -->

<!-- ## CLOSEDBLOK: Status.R -->
```{r status, include = TRUE, echo = FALSE, results='asis', code =  readLines(paste0(here::here(),"/01. Includes/code/Status.R"))} 
```
<!-- ## /CLOSEDBLOK: Status.R -->

<!-- ## CLOSEDBLOK: Reticulate.R -->

<!-- ## /CLOSEDBLOK: Reticulate.R -->

<!-- ## OPENBLOK: Data-aanmaken.R -->
```{r aanmaken data, include=FALSE, echo=TRUE}
source(paste0(here::here(),"/01. Includes/data/15.R"))
```
<!-- ## /OPENBLOK: Data-aanmaken.R -->

# Toepassing

Gebruik *Cochran's Q toets* om te toetsen of er verschillen zijn op een binaire variabele[^1] tussen drie of meer herhaalde metingen van één groep of tussen drie of meer gepaarde groepen.[^2]


# Onderwijscasus
<div id = "casus">
De opleidingsdirecteur van de bacheloropleiding Kunstmatige Intelligentie merkt dat er tijdens het eerste studiejaar veel studenten zijn die niet alle vakken voldoende afsluiten. Hij wilt uitvinden in welke onderwijsperiode dit vooral plaatsvindt om te onderzoeken waardoor de studievertraging veroorzaakt wordt. Daarom vraagt hij studieresultaten op van eerstejaars studenten in het vorige collegejaar die niet zijn uitgevallen gedurende dat jaar. Met deze resultaten wilt hij onderzoeken of het percentage eerstejaars studenten dat een of meer herkansingen heeft, verschilt tussen de vier onderwijsperiodes.

*H~0~*: Het percentage studenten dat een of meerdere herkansingen heeft is gelijk in elke onderwijsperiode.


*H~A~*: Het percentage studenten dat een of meerdere herkansingen heeft is niet gelijk in elke onderwijsperiode.
</div>

# Assumpties

Om *Cochran's Q toets* uit te voeren, moeten de data aan een aantal voorwaarden voldoen. Er dient een categorische afhankelijke variabele te zijn met twee categorieën zonder overlap. Elke observatie past slechts in een van beide categorieën. Daarnaast zijn er drie of meer herhaalde metingen van één groep of zijn er drie of meer gepaarde groepen. In beide gevallen zijn de observationele eenheden een willekeurige steekproef van de populatie.[^3]

*Cochran's Q toets* is te gebruiken wanneer het product van het aantal observatie-eenheden en het aantal groepen groter of gelijk aan 24 is.[^4] Gebruik de exacte versie van *Cochran's Q toets* wanneer dit niet het geval is.[^5]

# De data bekijken
<!-- ## TEKSTBLOK: Data-bekijken1.R -->
Er is een dataset ingeladen genaamd `Herkansingen_kunstmatige_intelligentie`. In deze dataset is per onderwijsperiode aangegeven of een student wel of geen herkansingen heeft gemaakt.

<!-- ## /TEKSTBLOK: Data-bekijken1.R -->

<!-- ## OPENBLOK: Data-bekijken2.R -->
```{r data bekijken, collapse=TRUE}
## Eerste 6 observaties
head(Herkansingen_kunstmatige_intelligentie)

## Laatste 6 observaties
tail(Herkansingen_kunstmatige_intelligentie)
```
<!-- ## /OPENBLOK: Data-bekijken2.R -->

<!-- ## TEKSTBLOK: Data-kruistabel1.R -->

Een kruistabel geeft weer hoeveel studenten wel of geen herkansingen hebben in de vier onderwijsperiodes. Maak de kruistabel met de functie `table()` met als argumenten de variabele `Herkansingen_kunstmatige_intelligentie$Herkansingen` die aangeeft of studenten wel of geen herkansing hebben en de variabele `Herkansingen_kunstmatige_intelligentie$Onderwijsperiode` die aangeeft in welke onderwijsperiode een observatie is gedaan. 
<!-- ## /TEKSTBLOK: Data-kruistabel1.R -->

<!-- ## OPENBLOK: Data-kruistabel2.R -->

```{r kruistabel}

## Maak een kruistabel
Herkansingen_kruistabel <- table(Herkansingen_kunstmatige_intelligentie$Herkansingen, Herkansingen_kunstmatige_intelligentie$Onderwijsperiode)

## Print de kruistabel 
print(Herkansingen_kruistabel)

## Print een tabel met proporties, tweede argument 2 zorgt ervoor dat de 
## proporties per kolom berekend worden
prop.table(Herkansingen_kruistabel, 2)
```
<!-- ## /OPENBLOK: Data-kruistabel2.R -->

De kruistabel en bijbehorende tabel met proporties laten zien dat het aantal studenten dat een herkansing doet in onderwijsperiode 1 relatief laag is en relatief hoog is in onderwijsperiode 2. Onderwijsperiode 3 en 4 zitten qua aantal herkansende studenten er tussenin.  

# Uitvoering

## Cochran's Q toets
<!-- ## TEKSTBLOK: McNemar-toets1.R -->
Voer *Cochran's Q toets* uit om te onderzoeken of er verschillen zijn tussen de vier onderwijsperiodes wat betreft het percentage studenten van de bachelor kunstmatige intelligentie dat een of meerdere herkansingen heeft gemaakt. Gebruik de functie `CochransQTest()` met als eerste argument `Herkansingen ~ Onderwijsperiode | Studentnummer` waarin `Herkansingen` de afhankelijke variabele is, `Onderwijsperiode` de variabele is die de verschillende groepen aangeeft en `Studentnummer` de variabele is die de observatie-eenheden aangeeft. Het tweede argument is de dataset `data = Herkansingen_kunstmatige_intelligentie`.
<!-- ## /TEKSTBLOK: McNemar-toets1.R -->

<!-- ## OPENBLOK: McNemar-toets2.R -->
```{r mcnemar}
CochranQTest(Herkansingen ~ Onderwijsperiode | Studentnummer,
              data = Herkansingen_kunstmatige_intelligentie)
```
<!-- ## /OPENBLOK: McNemar-toets2.R -->

<!-- ## CLOSEDBLOK: McNemar-toets3.R -->
```{r mcnemar object, include=FALSE, echo=TRUE}
mcnemar <- mcnemar.test(FOS_studenten_confusiematrix, correct = FALSE)
vChi2 <- Round_and_format(mcnemar$statistic)
vdf <- Round_and_format(mcnemar$parameter)
vp <- Round_and_format(mcnemar$p.value)
```
<!-- ## /CLOSEDBLOK: McNemar-toets3.R -->

Bereken het verschil proportie en bijbehorend betrouwbaarheidsinterval als effectmaat.

<!-- ## OPENBLOK: McNemar-toets5.R -->
```{r verschil proportie}
# Bereken de proporties FOS voor juni en december
Proportie_FOS_juni <- sum(FOS_studenten_confusiematrix[,"ja"])/sum(FOS_studenten_confusiematrix)
Proportie_FOS_december <- sum(FOS_studenten_confusiematrix["ja",])/sum(FOS_studenten_confusiematrix)

# Bereken het verschil in proporties
Verschil_proporties <- Proportie_FOS_juni - Proportie_FOS_december

# Bereken de standaardafwijking
Verschil_proporties_standaardafwijking <- sqrt((FOS_studenten_confusiematrix["nee","ja"] + FOS_studenten_confusiematrix["ja","nee"]) / sum(FOS_studenten_confusiematrix)^2 )  

# Bereken het 95%-betrouwbaarheidsinterval
Betrouwbaarheidsinterval <- c(Verschil_proporties - 1.96 * Verschil_proporties_standaardafwijking,
                              Verschil_proporties + 1.96 * Verschil_proporties_standaardafwijking)
# Print het interval
paste("Het verschil in proporties is", Verschil_proporties,"met bijbehorend 95%-betrouwbaarheidsinterval van",
      Betrouwbaarheidsinterval[1],"tot", Betrouwbaarheidsinterval[2])

```
<!-- ## /OPENBLOK: McNemar-toets5.R -->


<!-- ## TEKSTBLOK: McNemar-toets5.R -->
* $\chi^2$~`r vdf`~ = `r vChi2`, *p* < 0,0001  
* p-waarde < 0,05, dus de H~0~ wordt verworpen.[^6]

<!-- ## /TEKSTBLOK: McNemar-toets5.R -->


## Post-hoc toets


# Rapportage

<!-- ## TEKSTBLOK: McNemar-toets5.R -->
De *McNemar toets* is uitgevoerd om uit te vinden of er een verschil is in het percentage studenten dat een beroep doet op de FOS voor en na de interventie van de decaan. De interventie heeft als doel het aantal studenten met een functiebeperking dat een beroep doet op de FOS te verhogen. De resultaten laten een significant verschil zien tussen de percentages voor en na de interventie ($\chi^2$~`r vdf`~ = `r vChi2`, *p* <0,0001), wat betekent dat de nulhypothese verworpen kan worden. De kruistabel (Tabel 2) illustreert dat het percentage studenten dat een beroep doet op de FOS is toegenomen na de interventie; de *McNemar toets* toont aan dat deze toename significant is. 

|                      | December | Juni |
| -------------------- | -------------| ------------| 
| **FOS** | `r FOS_studenten_kruistabel["ja","december"]`    | `r FOS_studenten_kruistabel["ja","juni"]`     |
| **geen FOS**  | `r FOS_studenten_kruistabel["nee","december"]`      | `r FOS_studenten_kruistabel["nee","juni"]`     |
*Tabel 2. Kruistabel van het aantal studenten dat een beroep doet op de FOS in december en juni*

<!-- ## /TEKSTBLOK: McNemar-toets5.R -->

# Exacte McNemar toets

## Uitvoering

<!-- ## TEKSTBLOK: exMcNemar-toets1.R -->
Bij een lage hoeveelheid observaties (minder dan 11) in de niet-diagonale elementen van de confusiematrix is de exacte versie van de *McNemar toets* nuttig om te gebruiken. Om deze toets te illustreren bij deze casus wordt een confusiematrix `EMN_confusiematrix` ingeladen waarbij de niet-diagonale elementen minder dan 11 observaties bevatten. Voer de exacte versie van de *McNemar toets* uit om te onderzoeken of er een verschil is tussen het percentage studenten dat een beroep doet op de FOS voor en na de interventie van de decaan. 
<!-- ## /TEKSTBLOK: exMcNemar-toets1.R -->

<!-- ## OPENBLOK: exMcNemar-toets2.R -->
```{r EMNconfusiematrix}
print(EMN_confusiematrix)
```
<!-- ## /OPENBLOK: exMcNemar-toets2.R -->

Print de bijbehorende kruistabel en de proporties om het aantal studenten dat wel of niet een beroep op de FOS doet te laten zien voor en na de interventie.
<!-- ## OPENBLOK: exMcNemar-toets3.R -->
```{r EMNkruistabel}
# Print de kruistabel
print(EMN_kruistabel)
# Print een tabel met proporties, tweede argument 2 zorgt ervoor dat de 
# proporties per kolom berekend worden
prop.table(EMN_kruistabel, 2)
```
<!-- ## /OPENBLOK: exMcNemar-toets3.R -->
Het aantal studenten dat een beroep op de FOS doet is in juni iets hoger.

<!-- ## TEKSTBLOK: exMcNemar-toets4.R -->
Gebruik de functie `mcnemar.exact()` met als eerste argument de confusiematrix `EMN_confusiematrix` en als tweede argument `conf.level = 0.95` om een significantieniveau van 0,05 te gebruiken.
<!-- ## /TEKSTBLOK: exMcNemar-toets4.R -->

<!-- ## OPENBLOK: exMcNemar-toets5.R -->
```{r exmcnemar, warning=FALSE,message=FALSE}
library(exact2x2)
mcnemar.exact(EMN_confusiematrix, conf.level = 0.95)
```
<!-- ## /OPENBLOK: exMcNemar-toets5.R -->

<!-- ## TEKSTBLOK: exMcNemar-toets6.R -->
* p-waarde is `r mcnemar.exact(EMN_confusiematrix, conf.level = 0.95)$p.value`, dus de H~0~ kan niet worden verworpen.[^6]

<!-- ## /TEKSTBLOK: exMcNemar-toets6.R -->

## Rapportage

<!-- ## TEKSTBLOK: exMcNemar-toets7.R -->
De exacte versie van de *McNemar toets* is uitgevoerd om uit te vinden of er een verschil is in het percentage studenten dat een beroep doet op de FOS voor en na de interventie van de decaan. De interventie heeft als doel het aantal studenten met een functiebeperking dat een beroep doet op de FOS te verhogen. De resultaten laten geen significant verschil zien tussen de percentages voor en na de interventie (*p* = `r mcnemar.exact(EMN_confusiematrix, conf.level = 0.95)$p.value`), dus de nulhypothese kan niet worden verworpen. De kruistabel (Tabel 3) illustreert dat het aantal studenten dat een beroep doet op de FOS iets hoger is in juni. Dit verschil is echter niet significant.


|                      | December | Juni |
| -------------------- | -------------| ------------| 
| **FOS** | `r EMN_kruistabel["FOS","December"]`    | `r EMN_kruistabel["FOS","Juni"]`      |
| **geen FOS**  | `r EMN_kruistabel["geen FOS","December"]`       | `r EMN_kruistabel["geen FOS","Juni"]`      |
*Tabel 3. Kruistabel van het aantal studenten dat een beroep doet op de FOS in december en juni*



<!-- ## /TEKSTBLOK: exMcNemar-toets7.R -->

<!-- ## CLOSEDBLOK: Footer.R -->
```{r footer, include = TRUE, echo = FALSE, results='asis', code =  readLines(paste0(here::here(),"/01. Includes/code/Footer.R"))}
```
<!-- ## /CLOSEDBLOK: Footer.R -->

[^1]: Binaire variabelen: twee elkaar uitsluitende waarden, zoals ja of nee, 0 of 1, aan of uit.
[^2]: Allen, P. & Bennett, K. (2012). *SPSS A practical Guide version 20.0*. Cengage Learning Australia Pty Limited.
[^3]: Laerd statistics (2018). *Cochran's Q test using SPSS Statistics*. [Laerd statistics](https://statistics.laerd.com/spss-tutorials/cochrans-q-test-in-spss-statistics.php#assumption4) 
[^4]: Statistics How To (18 juli 2016). *Cochran’s Q Test*. [Statistics How to](https://www.statisticshowto.datasciencecentral.com/cochrans-q-test/).
[^5]: Er is geen package kunnen vinden om de exacte versie van *Cochran's Q toets* uit te voeren in R. De exacte versie is echter wel uit te voeren in SPSS.





[^2]: Van Geloven, N., & Holman, R., (4 juni 2014). *McNemar toets*. [Wiki Statistiek Academisch Medisch Centrum](https://wikistatistiek.amc.nl/index.php/McNemar_toets). 
[^3]: Laerd statistics (2018). *McNemar's test using SPSS Statistics*. [Laerd statistics](https://statistics.laerd.com/spss-tutorials/mcnemars-test-using-spss-statistics.php) 
[^4]: Agresti, A. (2003). *Categorical data analysis*. Vol. 482, John Wiley & Sons.
[^5]: Field, A., Miles, J., & Field, Z. (2012). *Discovering statistics using R*. London: Sage publications.
[^6]: In dit voorbeeld wordt uitgegaan van een waarschijnlijkheid van 95% c.q. een p-waardegrens van 0,05. De grens is naar eigen inzicht aan te passen; houd hierbij rekening met type I en type II fouten. 
